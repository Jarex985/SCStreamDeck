<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no,minimal-ui,viewport-fit=cover" name=viewport>
    <meta content=yes name=apple-mobile-web-app-capable>
    <meta content=black name=apple-mobile-web-app-status-bar-style>
    <title>Star Citizen Simple Button</title>

    <link href="../easy-pi/src/sdpi.css" rel="stylesheet">
    <link href="../sc-overrides.css" rel="stylesheet">
    <script src="../easy-pi/src/sdtools.common.js"></script>
</head>
<body>
<div class="sdpi-wrapper">

    <!-- Function Selection Dropdown -->
    <div class="sdpi-item sc-wide">
        <label class="sdpi-item-label" for="function">Function</label>
        <select class="sdpi-item-value select sdProperty" id="function"
                onchange="updateFunctionDetails()"
                oninput="setSettings()">
            <option value="">Loading Star Citizen functions...</option>
        </select>
    </div>

    <!-- Function Details Panel -->
    <div class="sdpi-item sc-wide" id="functionDetailsRow">
        <div class="sdpi-item-label">Details</div>
        <div class="sdpi-item-value">
            <div class="sc-details" id="functionDetails">
                <div class="sc-details-unbound">Select a function to see bindings.</div>
            </div>
        </div>
    </div>

    <!-- Status Row -->
    <div class="sdpi-item sc-wide" id="statusRow">
        <div class="sdpi-item-label">Status</div>
        <div class="sdpi-item-value" id="status">Waiting for pluginâ€¦</div>
    </div>

</div>

<script>
    // Store all function data for details lookup
    let allFunctionsData = [];
    let currentFunctionValue = '';

    // Override EasyPI's loadConfiguration to capture the function value
    const originalLoadConfiguration = loadConfiguration;
    loadConfiguration = function (payload) {
        // Call original to handle other properties
        originalLoadConfiguration(payload);

        // Store the function value for later restoration
        if (payload && payload.function) {
            currentFunctionValue = payload.function;

            // If dropdown is already populated, restore the value
            const select = document.getElementById('function');
            if (select && select.options.length > 1) {
                select.value = currentFunctionValue;
                updateFunctionDetails();
            }
        }
    };

    function escapeHtml(str) {
        return String(str || '')
            .replaceAll('&', '&amp;')
            .replaceAll('<', '&lt;')
            .replaceAll('>', '&gt;')
            .replaceAll('"', '&quot;')
            .replaceAll('\'', '&#039;');
    }

    function deviceLabel(device) {
        switch ((device || '').toLowerCase()) {
            case 'keyboard':
                return 'Keyboard';
            case 'mouse':
                return 'Mouse';
            case 'mouseaxis':
                return 'Mouse Axis';
            case 'joystick':
                return 'Joystick';
            case 'gamepad':
                return 'Gamepad';
            default:
                return device || 'Device';
        }
    }

    function setStatus(text) {
        const el = document.getElementById('status');
        if (el) el.textContent = text;
    }

    function renderDetails(details) {
        const detailsEl = document.getElementById('functionDetails');
        if (!detailsEl) return;

        if (!details) {
            detailsEl.innerHTML = '<div class="sc-details-unbound">Select a function to see bindings.</div>';
            return;
        }

        const title = escapeHtml(details.label || '');
        const desc = escapeHtml(details.description || '');
        const devices = Array.isArray(details.devices) ? details.devices : [];

        let html = '';
        html += `<div class="sc-details-title">${title}</div>`;
        if (desc) {
            html += `<div class="sc-details-desc">${desc}</div>`;
        }

        if (!devices.length) {
            html += `<div class="sc-details-unbound">(currently unbound)</div>`;
            detailsEl.innerHTML = html;
            return;
        }

        html += '<div class="sc-details-grid">';
        devices.forEach(d => {
            const devName = escapeHtml(deviceLabel(d.device));
            const bindings = Array.isArray(d.bindings) ? d.bindings : [];

            const bindingLines = bindings
                .map(b => escapeHtml(b.display || b.raw || ''))
                .filter(x => x);

            html += `<div class="sc-details-device">${devName}</div>`;
            html += `<div class="sc-details-bindings">${bindingLines.join('\n') || '-'}</div>`;
        });
        html += '</div>';

        if (details.canonicalActionName) {
            html += `<div class="sc-details-meta">Canonical: ${escapeHtml(details.canonicalActionName)}</div>`;
        }

        detailsEl.innerHTML = html;
    }

    function populateDropdown(functionsData, selectedValue) {
        const select = document.getElementById('function');
        if (!select) return;

        // Clear existing options
        select.innerHTML = '';

        // Add empty option
        const emptyOption = document.createElement('option');
        emptyOption.value = '';
        emptyOption.textContent = '-- Select a function --';
        select.appendChild(emptyOption);

        // Add grouped options
        (functionsData || []).forEach(group => {
            const optgroup = document.createElement('optgroup');
            optgroup.label = group.label;

            (group.options || []).forEach(opt => {
                const option = document.createElement('option');
                option.value = opt.value;
                option.textContent = opt.text;

                if (opt.disabled) {
                    option.disabled = true;
                }

                optgroup.appendChild(option);
            });

            select.appendChild(optgroup);
        });

        // Restore selected value if provided
        if (selectedValue) {
            select.value = selectedValue;
        }
    }

    function updateFunctionDetails() {
        const select = document.getElementById('function');
        if (!select) return;

        const selectedValue = select.value;
        if (!selectedValue) {
            renderDetails(null);
            return;
        }

        // Find the details for this function in our stored data
        for (const group of allFunctionsData) {
            const options = group.options || [];
            for (const opt of options) {
                if (opt.value === selectedValue && opt.details) {
                    renderDetails(opt.details);
                    return;
                }
            }
        }

        renderDetails(null);
    }

    // Capture sendToPropertyInspector payloads (custom messages from plugin)
    document.addEventListener('websocketCreate', function () {
        const originalOnMessage = websocket.onmessage;

        websocket.onmessage = function (evt) {
            const jsonObj = JSON.parse(evt.data);

            if (jsonObj.event === 'sendToPropertyInspector' && jsonObj.payload) {
                if (jsonObj.payload.functionsLoaded) {
                    // Store the functions data for details lookup
                    allFunctionsData = jsonObj.payload.functions || [];

                    // Manually populate the dropdown with the functions
                    // Use the saved currentFunctionValue to restore selection
                    populateDropdown(allFunctionsData, currentFunctionValue);

                    setStatus(jsonObj.payload.status || 'Functions loaded');

                    // Update details for currently selected function
                    updateFunctionDetails();
                }
                if (jsonObj.payload.status) {
                    setStatus(jsonObj.payload.status);
                }
            }

            if (originalOnMessage) {
                originalOnMessage.call(this, evt);
            }
        };
    });

    document.addEventListener('DOMContentLoaded', function () {
        // Update details when selection changes
        const functionSelect = document.getElementById('function');
        if (functionSelect) {
            functionSelect.addEventListener('change', updateFunctionDetails);
        }

        // Let plugin know PI is ready
        try {
            sendValueToPlugin('propertyInspectorConnected', 'property_inspector');
        } catch (e) {
            // ignore
        }
    });
</script>
</body>
</html>
